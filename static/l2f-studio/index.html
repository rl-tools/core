<html>
<head>
    <meta charset="utf-8">
    <title>L2F Studio</title>
    <style>
        body{
            display: flex;
            justify-content: center;
        }
        .l2f-canvas{
            /*width: min(90vh, 90vw);*/
            /*height: min(90vh, 90vw);*/
            width: 100%;
            background-color: white;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "./lib/three.module.js",
                "three-orbitcontrols": "./lib/OrbitControls.js"
            }
        }
    </script>
    <script type="module">
        import * as rlt from "/static/rl_tools/rl_tools.js"
        import * as math from 'https://esm.sh/mathjs'

        const file_url = "/experiments/2025-02-24_21-31-59/7cfb0a9_zoo_environment_algorithm/l2f_sac/0000/steps/000000001000000/checkpoint.h5"

        const DEBUG = true
        import * as ui from "./ui.js"
        import createModule from './l2f-interface.js';

        class L2F {
            constructor(parent, num_quadrotors, policy, seed){
                this.canvas = document.createElement('canvas');
                this.canvas.classList.add('l2f-canvas');
                const dpr = window.devicePixelRatio || 1;
                const resizeCanvas = ()=>{
                    this.canvas.width = this.canvas.clientWidth * dpr;
                    this.canvas.height = this.canvas.clientHeight * dpr;
                }
                // resizeCanvas()
                window.addEventListener('resize', resizeCanvas.bind(this), false);
                this.policy = policy

                this.initialized = createModule().then(async (l2f_interface) => {
                    this.states = [...Array(num_quadrotors)].map((_, i) =>new l2f_interface.State(seed + i));
                    if(DEBUG){
                        this.ui = ui
                    }
                    else{
                        const blob = new Blob([this.states[0].get_ui()], { type: 'application/javascript' });
                        const url = URL.createObjectURL(blob);
                        this.ui = await import(url)
                        URL.revokeObjectURL(url);
                    }
                    this.ui_state = await this.ui.init(this.canvas, {devicePixelRatio: window.devicePixelRatio})
                    if(this.ui_state.cursor_grab){
                        this.canvas.style.cursor = "grab"
                    }
                    parent.appendChild(this.canvas);
                    this.parameters = this.states.map(state => JSON.parse(state.get_parameters()))
                    await this.ui.episode_init_multi(this.ui_state, this.parameters)
                    this.render()
                });
                this.last_step = null
                this.last_dt = 0
            }
            async render(){
                const now = performance.now()
                if(this.last_step === null || (now - this.last_step) / 1000 > this.last_dt){
                    this.last_step = now

                    this.states.forEach(state => {
                        const action = this.policy(state)
                        console.assert(action.length === state.action_dim, "Action dimension mismatch")
                        action.map((v, i) => {
                            state.set_action(i, v)
                        })
                        this.last_dt = state.step()
                    })
                }
                const current_states =  this.states.map(state => JSON.parse(state.get_state()))
                const current_actions = this.states.map(state => JSON.parse(state.get_action()))
                await this.ui.render_multi(this.ui_state, this.parameters, current_states, current_actions)
                requestAnimationFrame(() => this.render());
            }
        }

        async function main(){
            const seed = 12
            const model = await rlt.load(file_url)
            function policy(state){
                state.observe()
                const input = math.matrix([[[...Array(state.observation_dim).keys()].map(i => state.get_observation(i))]])
                const output = model.evaluate(input)
                return output.valueOf()[0][0]
            }
            const l2f = new L2F(document.body, 10, policy, seed)
        }
        window.onload = main
    </script>
</head>
<body style="background-color: black">
<!--<canvas id="canvas" style="background-color: white;"></canvas>-->
</body>
</html>